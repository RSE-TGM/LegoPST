#!/bin/bash
#
# Build e opzionalmente push dell'immagine Docker LegoPST
#
IMAGE_NAME="aguagliardi/legopst_multi:2.0"
PROCEED_AUTOMATICALLY=false
DO_PUSH=false
DOCKERFILE_PATH="LegoPST/docker/Dockerfile_LegoPST"
CONTEXT_PATH="."

# Controlla se Docker è installato
if ! command -v docker >/dev/null 2>&1; then
    echo "---------------------------------------------------------------------"
    echo "ATTENZIONE: Docker non sembra essere installato o non è nel PATH."
    echo "            Per favore, installa Docker per procedere con la build."
    echo "---------------------------------------------------------------------"
    exit 0
fi

# Analizza i parametri della riga di comando
while [[ "$#" -gt 0 ]]; do
    case $1 in
        -y|--yes)  PROCEED_AUTOMATICALLY=true; shift ;;
        --push)    DO_PUSH=true; shift ;;
        *) echo "Parametro sconosciuto: $1"
           echo "Uso: $(basename "$0") [-y|--yes] [--push]"
           echo "  -y, --yes   Procedi senza conferma"
           echo "  --push      Dopo il build, push al registry Docker Hub"
           exit 1 ;;
    esac
done

build_logic() {
    echo " "
    echo "---------------------------------------------------------------------"
    echo " Building dell'immagine Docker $IMAGE_NAME"
    echo " Modalità: solo build locale"
    [[ "$DO_PUSH" == true ]] && echo " Push al registry: SI"
    echo "---------------------------------------------------------------------"

    # Build dell'immagine in locale
    (cd ../.. && \
     docker build \
        -t "$IMAGE_NAME" \
        --file "$DOCKERFILE_PATH" \
        "$CONTEXT_PATH" \
    )

    local build_status=$?
    if [ $build_status -ne 0 ]; then
        echo "Errore nel building dell'immagine (exit code: $build_status)"
        return $build_status
    fi

    echo "--------------> Fine building dell'immagine $IMAGE_NAME <---------------"

    # Push solo se richiesto esplicitamente
    if [[ "$DO_PUSH" == true ]]; then
        echo "Pushing $IMAGE_NAME al registry..."
        docker push "$IMAGE_NAME"
        local push_status=$?
        if [ $push_status -ne 0 ]; then
            echo "Errore nel push dell'immagine (exit code: $push_status)"
            echo "L'immagine è comunque disponibile in locale"
        else
            echo "--------------> Push completato: $IMAGE_NAME <---------------"
        fi
        return $push_status
    fi
    return 0
}

if [ "$PROCEED_AUTOMATICALLY" = true ]; then
    echo "Opzione -y rilevata, procedo automaticamente con la build."
    build_logic
    exit $?
else
    while true; do
        echo " "
        echo "Verrà costruita l'immagine Docker: $IMAGE_NAME"
        [[ "$DO_PUSH" == true ]] && echo "Dopo il build verrà eseguito il push al registry"
        read -p "Procedo? (y/n) " yn

        case $yn in
            [yY] )
                build_logic
                exit $?;;
            [nN] )
                echo "Operazione annullata dall'utente."
                exit 0;;
            * )
                echo "Risposta non valida. Per favore, inserisci 'y' o 'n'.";;
        esac
    done
fi
